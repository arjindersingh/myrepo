{% extends "appraisal_base.html" %}
{% block content %}

<div class="container mt-4"> 
  <h3 class="mb-3">
    Manage Employees not required to appraise by ({{ request.user }}) for AY: <strong>{{ CAY.display_name }}</strong>.
  </h3>

  <!-- Messages -->
  {% if messages %}
  {% for m in messages %}
  <div class="alert alert-{{ m.tags|default:'info' }} alert-dismissible fade show" role="alert">
    {{ m }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
  {% endif %}

  <!-- Add form -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Add Employee to Exclusion List</h5>
      <p class="card-text">
        <strong>Tip:</strong> Add yourself to avoid self-evaluation.
      </p>

      <form method="post" id="add-form" class="needs-validation">
        {% csrf_token %}
        {{ form.ex_employee }} <!-- hidden -->

        <div class="row g-3 align-items-end">
          <!-- Appraisal Type -->
          <div class="col-md-4">
            <label class="form-label">{{ form.appraisal_type.label }}</label>
            {{ form.appraisal_type }}
            {% if form.appraisal_type.errors %}
            <div class="text-danger small">{{ form.appraisal_type.errors }}</div>
            {% endif %}
          </div>

          <!-- Employee Search -->
          <div class="col-md-8 position-relative">
            <label for="emp-search" class="form-label">Employee</label>
            <input type="text" id="emp-search" class="form-control" placeholder="Search employee by name or code…"
              autocomplete="off">
            <ul class="list-group position-absolute w-100" id="emp-results" hidden
              style="z-index: 1000; max-height: 250px; overflow-y: auto;">
            </ul>
          </div>
          <p class="text-muted small mt-2">
            Type at least 2 characters to search. Click a result to select it, then press Add.
          </p>
        </div>

        <!-- Description -->
        <div class="row mt-9 align-items-end">
          <!-- Description -->
          <div class="col-md-9">
            <label class="form-label">{{ form.description.label }}</label>
            {{ form.description }}
          </div>

          <!-- Submit -->
          <div class="col-md-3 text-end">
            <button type="submit" class="btn btn-primary w-100">Add</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- List -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Excluded Employees for {{ request.user }} for {{CAY.display_name}})</h5>
      {% if exclusions %}
      <div class="table-responsive">
        <div class="mb-3">
          <input type="text" id="tableSearch" class="form-control"
            placeholder="Search exclusions (employee, appraisal type, description)...">
        </div>

        <div class="table-responsive">
          <table id="exclusionsTable" class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th>Appraisal Type</th>
                <th>Description</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for e in exclusions %}
              <tr>
                <td>{{ e.ex_employee }}</td>
                <td>{{ e.appraisal_type }}</td>
                <td>{{ e.description|default:"—" }}</td>
                <td class="text-end">
                  <form method="post" action="{% url 'excluded-delete' e.pk %}" class="d-inline"
                    onsubmit="return confirm('Remove this exclusion?')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
      {% else %}
      <p class="text-muted">No exclusions yet for the current year.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Tiny debounce
  function debounce(fn, ms) { let t; return function () { clearTimeout(t); t = setTimeout(() => fn.apply(this, arguments), ms); } }

  const input = document.getElementById('emp-search');
  const results = document.getElementById('emp-results');
  const hiddenField = document.getElementById('id_ex_employee');
  const form = document.getElementById('add-form');

  function clearResults() { results.innerHTML = ''; results.hidden = true; }

  async function doSearch(q) {
    if (!q || q.length < 2) { clearResults(); return; }
    const url = new URL("{% url 'employee-lookup' %}", window.location.origin);
    url.searchParams.set('q', q);
    const r = await fetch(url);
    if (!r.ok) { clearResults(); return; }
    const data = await r.json();
    const items = data.results || [];
    if (items.length === 0) { clearResults(); return; }
    results.innerHTML = items.map(item =>
      `<li class="list-group-item list-group-item-action" data-id="${item.id}">${item.label}</li>`
    ).join('');
    results.hidden = false;
  }

  input.addEventListener('input', debounce((e) => doSearch(e.target.value.trim()), 200));

  results.addEventListener('click', (e) => {
    const li = e.target.closest('li');
    if (!li) return;
    hiddenField.value = li.dataset.id;
    input.value = li.textContent.trim();
    clearResults();
  });

  // Prevent accidental submit if no employee chosen
  form.addEventListener('submit', (e) => {
    if (!hiddenField.value) {
      e.preventDefault();
      alert("Please select an employee from search results before adding.");
    }
  });

  // Click outside to close results
  document.addEventListener('click', (e) => {
    if (!results.contains(e.target) && e.target !== input) {
      clearResults();
    }
  });

  const searchInput = document.getElementById("tableSearch");
  const table = document.getElementById("exclusionsTable");
  const rows = table.getElementsByTagName("tr");

  searchInput.addEventListener("keyup", function () {
    const filter = searchInput.value.toLowerCase();

    // Loop over table rows (skip header row at index 0)
    for (let i = 1; i < rows.length; i++) {
      let row = rows[i];
      let text = row.innerText.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    }
  });


</script>
{% endblock %}